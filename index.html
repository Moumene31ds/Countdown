<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Event Master V7 Mobile</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òÑÔ∏è</text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-glass: rgba(30, 41, 59, 0.85);
            --accent: #38bdf8;
            --text: #f8fafc;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --blur: 12px;
        }

        [data-theme="light"] {
            --bg-dark: #f8fafc;
            --card-glass: rgba(255, 255, 255, 0.95);
            --accent: #2563eb;
            --text: #1e293b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.15), transparent 40%), 
                radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.15), transparent 40%);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* --- Navbar --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.2rem; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(15px);
            position: sticky; top: 0; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .logo { 
            font-size: 1.3rem; font-weight: 900; 
            background: linear-gradient(135deg, var(--accent), #c084fc); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            display: flex; align-items: center; gap: 8px;
        }
        
        .nav-actions { display: flex; gap: 8px; }
        .icon-btn { 
            background: rgba(255,255,255,0.05); border: none; 
            color: var(--text); font-size: 1.1rem; cursor: pointer; 
            width: 38px; height: 38px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.95); background: var(--accent); color: white; }

        /* --- Stats Bar (Scrollable) --- */
        .stats-bar {
            display: flex; gap: 10px; overflow-x: auto; padding: 1rem 1.2rem;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .stats-bar::-webkit-scrollbar { display: none; }
        
        .stat-chip {
            background: var(--card-glass); padding: 8px 16px; border-radius: 50px;
            font-size: 0.85rem; white-space: nowrap; border: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; gap: 8px; cursor: pointer; flex-shrink: 0;
            transition: 0.3s;
        }
        .stat-chip.active { border-color: var(--accent); background: rgba(56, 189, 248, 0.15); color: var(--accent); font-weight: 700; }

        /* --- Responsive Grid --- */
        .grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px; padding: 0.5rem 1.2rem; max-width: 1400px; margin: 0 auto;
        }

        @media (max-width: 600px) {
            .grid { 
                grid-template-columns: 1fr; /* Full width on mobile */
                gap: 15px;
            }
            .modal { width: 95% !important; padding: 1.5rem !important; }
        }

        /* --- Card Design --- */
        .card {
            background: var(--card-glass); border-radius: 24px; overflow: hidden;
            position: relative; border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 15px -1px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; transition: transform 0.3s;
        }
        .card.pinned { border: 2px solid var(--accent); }
        .card.urgent:not(.past-event) { border-color: var(--danger); animation: pulseUrgent 2s infinite; }
        @keyframes pulseUrgent { 50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.3); } }

        .card-bg {
            height: 140px; width: 100%; background-size: cover; background-position: center;
            position: relative;
        }
        .card-bg::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), var(--card-glass));
        }

        .card-badges { position: absolute; top: 12px; left: 12px; right: 12px; display: flex; justify-content: space-between; z-index: 10; pointer-events: none; }
        .badge {
            background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 10px; 
            font-size: 0.75rem; color: white; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 5px;
            pointer-events: auto; font-weight: 500;
        }

        .card-body { padding: 0 20px 20px; position: relative; flex-grow: 1; display: flex; flex-direction: column; }
        
        .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-top: -20px; margin-bottom: 10px; z-index: 2; position: relative; }
        .card-title { font-size: 1.5rem; font-weight: 800; line-height: 1.2; text-shadow: 0 2px 5px rgba(0,0,0,0.2); flex: 1; word-wrap: break-word; }
        
        .pin-btn { 
            background: rgba(255,255,255,0.15); border: none; color: var(--text); 
            width: 34px; height: 34px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .pin-btn.active { color: var(--warning); background: rgba(245, 158, 11, 0.2); }
        
        .notes-indicator { font-size: 0.8rem; color: var(--accent); margin-top: 5px; display: flex; align-items: center; gap: 5px; opacity: 0.8; }

        /* Timer */
        .timer-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center; 
            background: rgba(0,0,0,0.2); padding: 12px; border-radius: 18px;
            margin-top: 15px; border: 1px solid rgba(255,255,255,0.05);
        }
        .timer-box { display: flex; flex-direction: column; align-items: center; }
        .timer-num { font-size: 1.6rem; font-weight: 800; color: var(--accent); line-height: 1; }
        .timer-label { font-size: 0.65rem; opacity: 0.6; margin-top: 4px; }

        /* Progress Bar */
        .progress-container { margin-top: 15px; margin-bottom: 10px; }
        .progress-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 1s linear; }

        .card-footer {
            margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.08);
            display: flex; gap: 8px; justify-content: flex-end;
        }

        .past-event { border-color: var(--success); }
        .past-event .timer-num { color: var(--success); }
        .past-event .progress-fill { background: var(--success); }

        /* Floating Button */
        .fab {
            position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px;
            background: var(--accent); border-radius: 20px; color: white; display: flex;
            align-items: center; justify-content: center; font-size: 1.5rem;
            box-shadow: 0 15px 30px -5px rgba(56, 189, 248, 0.5); 
            cursor: pointer; z-index: 90; transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.05); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 100; display: none; align-items: center; justify-content: center;
            padding: 1rem;
        }
        .modal {
            background: #1e293b; width: 100%; max-width: 500px; padding: 2rem;
            border-radius: 28px; border: 1px solid rgba(255,255,255,0.1);
            max-height: 90vh; overflow-y: auto;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .form-group { margin-bottom: 1.2rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 700; opacity: 0.9; }
        .form-input, .form-textarea, .form-select {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px; color: var(--text); outline: none; font-size: 16px; /* Prevents zoom on iOS */
        }
        .form-textarea { resize: none; height: 80px; }
        .form-select { appearance: none; }

        .category-select { display: flex; gap: 8px; flex-wrap: wrap; }
        .cat-option {
            padding: 10px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; font-size: 0.85rem; background: rgba(255,255,255,0.05); flex: 1; text-align: center;
        }
        .cat-option.selected { background: var(--accent); color: white; border-color: transparent; font-weight: bold; }

        .toggle-switch {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; cursor: pointer;
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 14px;
        }
        .toggle-track {
            width: 44px; height: 24px; background: rgba(0,0,0,0.3); border-radius: 20px;
            position: relative; transition: 0.3s;
        }
        .toggle-thumb {
            width: 18px; height: 18px; background: white; border-radius: 50%;
            position: absolute; top: 3px; left: 3px; transition: 0.3s;
        }
        .toggle-active .toggle-track { background: var(--success); }
        .toggle-active .toggle-thumb { left: 23px; }

        /* QR & Toast */
        #qrContainer img { border-radius: 12px; border: 4px solid white; margin: 15px auto; display: block; max-width: 100%; }
        
        .toast {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 200; font-size: 0.9rem; font-weight: 500;
            display: flex; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.1);
            width: 90%; max-width: 350px; justify-content: center;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Dropdown */
        .dropdown { position: relative; }
        .dropdown-content {
            display: none; position: absolute; left: 0; bottom: 100%; margin-bottom: 5px;
            background: var(--bg-dark); min-width: 150px; border-radius: 14px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            z-index: 20; padding: 5px;
        }
        .dropdown:focus-within .dropdown-content { display: block; }
        .dropdown-btn { 
            width: 100%; text-align: right; padding: 12px; border-radius: 8px;
            background: transparent; border: none; color: var(--text); cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .dropdown-btn:hover { background: rgba(255,255,255,0.1); }

    </style>
</head>
<body>

    <nav>
        <div class="logo"><i class="fas fa-meteor"></i> EventMaster</div>
        <div class="nav-actions">
            <button class="icon-btn" onclick="requestNotificationPermission()" title="ÿ™ŸÜÿ®ŸäŸáÿßÿ™"><i class="fas fa-bell"></i></button>
            <button class="icon-btn" onclick="toggleTheme()" title="ÿ´ŸäŸÖ"><i class="fas fa-adjust"></i></button>
            <button class="icon-btn" onclick="exportData()" title="ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä"><i class="fas fa-file-export"></i></button>
            <button class="icon-btn" onclick="importData()" title="ÿßÿ≥ÿ™ÿπÿßÿØÿ©"><i class="fas fa-file-import"></i></button>
        </div>
    </nav>

    <div class="stats-bar">
        <div class="stat-chip active" onclick="filterEvents('all')">ÿßŸÑŸÉŸÑ</div>
        <div class="stat-chip" onclick="filterEvents('personal')">ÿ¥ÿÆÿµŸä</div>
        <div class="stat-chip" onclick="filterEvents('work')">ÿπŸÖŸÑ</div>
        <div class="stat-chip" onclick="filterEvents('holiday')">ÿπÿ∑ŸÑÿßÿ™</div>
        <div class="stat-chip" style="margin-right: auto; color: var(--accent); border-color: var(--accent);" onclick="showPresets()">
            <i class="fas fa-magic"></i>
        </div>
    </div>

    <div class="grid" id="eventsGrid">
        </div>

    <div class="fab" onclick="openModal()"><i class="fas fa-plus"></i></div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <h2 id="modalTitle" style="margin-bottom: 20px; font-size: 1.5rem;">ÿ≠ÿØÿ´ ÿ¨ÿØŸäÿØ</h2>
            
            <div class="form-group">
                <label class="form-label">ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ≠ÿØÿ´</label>
                <input type="text" class="form-input" id="inpTitle" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿπŸÜŸàÿßŸÜ...">
            </div>

            <div class="form-group">
                <label class="form-label">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™</label>
                <input type="datetime-local" class="form-input" id="inpDate">
            </div>

            <div class="form-group" style="display: flex; gap: 10px;">
                 <div style="flex:1">
                    <label class="form-label">ÿßŸÑÿ™ŸÉÿ±ÿßÿ±</label>
                    <select class="form-select form-input" id="inpRecur">
                        <option value="none">ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©</option>
                        <option value="annual">ÿ≥ŸÜŸàŸä</option>
                        <option value="monthly">ÿ¥Ÿáÿ±Ÿä</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ÿßŸÑÿ™ÿµŸÜŸäŸÅ</label>
                <div class="category-select" id="catSelect">
                    <div class="cat-option selected" data-val="personal">ÿ¥ÿÆÿµŸä</div>
                    <div class="cat-option" data-val="work">ÿπŸÖŸÑ</div>
                    <div class="cat-option" data-val="holiday">ÿπÿ∑ŸÑÿ©</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                <textarea class="form-textarea" id="inpNotes" placeholder="ÿ™ŸÅÿßÿµŸäŸÑ ÿ•ÿ∂ÿßŸÅŸäÿ©..."></textarea>
            </div>

            <div class="toggle-switch toggle-active" id="autoImgToggle" onclick="this.classList.toggle('toggle-active'); toggleImgInput()">
                <span style="font-size: 0.9rem;">ÿµŸàÿ±ÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© (AI)</span>
                <div class="toggle-track"><div class="toggle-thumb"></div></div>
            </div>

            <div class="form-group" id="imgInputGroup" style="display: none;">
                <input type="text" class="form-input" id="inpBg" placeholder="ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="icon-btn" onclick="closeModal()" style="width: 50px; background: rgba(255,255,255,0.1);"><i class="fas fa-times"></i></button>
                <button id="saveBtn" class="stat-chip active" onclick="saveEvent()" style="flex-grow: 1; justify-content: center; height: 45px; font-size: 1rem;">ÿ≠ŸÅÿ∏</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="shareModal">
        <div class="modal" style="text-align: center;">
            <i class="fas fa-share-alt" style="font-size: 2rem; color: var(--accent); margin-bottom: 15px;"></i>
            <h3 style="margin-bottom: 10px;">ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿ≠ÿØÿ´</h3>
            <div id="qrContainer"></div>
            <p style="margin: 10px 0; opacity: 0.7; font-size: 0.8rem;">ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸàÿØ ÿ£Ÿà ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑</p>
            <input type="text" class="form-input" id="shareInput" readonly onclick="this.select()" style="margin-bottom: 15px; text-align: center; direction: ltr;">
            <button class="stat-chip active" onclick="copyShareLink()" style="width: 100%; justify-content: center;">ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑</button>
            <button class="icon-btn" onclick="document.getElementById('shareModal').style.display='none'" style="width: 100%; margin-top: 10px; border-radius: 12px; justify-content: center;">ÿ•ÿ∫ŸÑÿßŸÇ</button>
        </div>
    </div>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i> <span id="toastMsg">ÿ™ŸÖ</span></div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        // --- Data & Initialization ---
        let events = JSON.parse(localStorage.getItem('masterEventsV7')) || [];
        
        // Migrate old data if needed
        if(localStorage.getItem('masterEventsV6')) {
            try {
                const old = JSON.parse(localStorage.getItem('masterEventsV6'));
                events = old.concat(events);
                localStorage.removeItem('masterEventsV6');
                save();
            } catch(e){}
        }

        let currentFilter = 'all';
        let editingId = null;
        let notifPermission = Notification.permission;

        // Start Up
        checkUrlForSharedEvent();
        renderEvents();
        setInterval(tick, 1000);

        // --- Core Logic ---

        function saveEvent() {
            const title = document.getElementById('inpTitle').value.trim();
            const dateVal = document.getElementById('inpDate').value;
            const recurrence = document.getElementById('inpRecur').value;
            const notes = document.getElementById('inpNotes').value.trim();
            const useAutoImg = document.getElementById('autoImgToggle').classList.contains('toggle-active');
            let bg = document.getElementById('inpBg').value.trim();
            const cat = document.querySelector('.cat-option.selected').dataset.val;

            if(!title || !dateVal) return showToast('ÿ£ÿØÿÆŸÑ ÿßŸÑÿπŸÜŸàÿßŸÜ ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ', true);

            // AI Image Logic
            if(useAutoImg || !bg) {
                bg = `https://source.unsplash.com/600x400/?${encodeURIComponent(title)},${cat}`;
            }

            if(editingId) {
                // Update
                const idx = events.findIndex(e => e.id === editingId);
                if(idx > -1) {
                    events[idx] = { 
                        ...events[idx], title, date: dateVal, bg, cat, notes, recurrence,
                        notified: (events[idx].date === dateVal) ? events[idx].notified : false 
                    };
                }
            } else {
                // Create New
                events.unshift({
                    id: Date.now(),
                    title, date: dateVal, bg, cat, notes, recurrence,
                    created: Date.now(),
                    pinned: false,
                    notified: false
                });
                
                // Confetti if event is soon
                if(new Date(dateVal) - new Date() < 86400000 && new Date(dateVal) > new Date()) {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
            }

            save();
            renderEvents();
            closeModal();
            showToast('ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function deleteEvent(id) {
            if(confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≠ÿ∞ŸÅÿü')) {
                events = events.filter(e => e.id !== id);
                save();
                renderEvents();
            }
        }

        function togglePin(id) {
            const ev = events.find(e => e.id === id);
            if(ev) {
                ev.pinned = !ev.pinned;
                save();
                renderEvents();
            }
        }

        function save() {
            localStorage.setItem('masterEventsV7', JSON.stringify(events));
        }

        // --- Rendering ---

        function renderEvents() {
            const grid = document.getElementById('eventsGrid');
            grid.innerHTML = '';
            
            let filtered = currentFilter === 'all' ? events : events.filter(e => e.cat === currentFilter);
            
            // Sort: Pinned first, then by date
            filtered.sort((a,b) => {
                if(a.pinned === b.pinned) return new Date(a.date) - new Date(b.date);
                return a.pinned ? -1 : 1;
            });

            if(filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; opacity: 0.5; margin-top: 60px;">
                    <i class="fas fa-meteor" style="font-size: 3.5rem; margin-bottom: 15px;"></i><br>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ≠ÿØÿßÿ´ ÿ≠ÿßŸÑŸäÿßŸã
                </div>`;
                return;
            }

            filtered.forEach(ev => {
                const now = new Date();
                const targetDate = new Date(ev.date);
                const isPast = targetDate < now;
                const isUrgent = !isPast && (targetDate - now) < (24 * 3600 * 1000); // Less than 24h
                
                const bgImage = ev.bg || 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=500';
                const recurIcon = ev.recurrence === 'annual' ? '<i class="fas fa-sync"></i> ÿ≥ŸÜŸàŸä' : (ev.recurrence === 'monthly' ? '<i class="fas fa-redo"></i> ÿ¥Ÿáÿ±Ÿä' : '');

                const card = document.createElement('div');
                card.className = `card ${isPast ? 'past-event' : ''} ${ev.pinned ? 'pinned' : ''} ${isUrgent ? 'urgent' : ''}`;
                card.innerHTML = `
                    <div class="card-bg" style="background-image: url('${bgImage}')">
                        <div class="card-badges">
                            <div style="display:flex; gap:5px;">
                                <span class="badge"><i class="fas fa-circle" style="font-size:0.6em; color:var(--accent)"></i> ${getCatLabel(ev.cat)}</span>
                                ${recurIcon ? `<span class="badge" style="background:var(--accent)">${recurIcon}</span>` : ''}
                            </div>
                            ${ev.pinned ? '<span class="badge" style="background:var(--warning); color:black"><i class="fas fa-thumbtack"></i></span>' : ''}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="card-header-row">
                            <h3 class="card-title">${ev.title}</h3>
                            <button class="pin-btn ${ev.pinned ? 'active' : ''}" onclick="togglePin(${ev.id})"><i class="fas fa-thumbtack"></i></button>
                        </div>
                        
                        ${ev.notes ? `<div class="notes-indicator"><i class="fas fa-align-right"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</div>` : ''}

                        <div class="timer-grid" id="timer-${ev.id}">
                            <div class="timer-box"><span class="timer-num d">0</span><span class="timer-label">ŸäŸàŸÖ</span></div>
                            <div class="timer-box"><span class="timer-num h">0</span><span class="timer-label">ÿ≥</span></div>
                            <div class="timer-box"><span class="timer-num m">0</span><span class="timer-label">ÿØ</span></div>
                            <div class="timer-box"><span class="timer-num s">0</span><span class="timer-label">ÿ´</span></div>
                        </div>

                        <div class="progress-container"><div class="progress-track"><div class="progress-fill" id="prog-fill-${ev.id}"></div></div></div>

                        <div class="card-footer">
                            <button class="icon-btn" onclick="speakTime(${ev.id})"><i class="fas fa-volume-up"></i></button>
                            <button class="icon-btn" onclick="editEvent(${ev.id})"><i class="fas fa-edit"></i></button>
                            <div class="dropdown">
                                <button class="icon-btn"><i class="fas fa-ellipsis-v"></i></button>
                                <div class="dropdown-content">
                                    <button class="dropdown-btn" onclick="generateShareLink(${ev.id})"><i class="fas fa-share-alt"></i> ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
                                    <button class="dropdown-btn" onclick="deleteEvent(${ev.id})" style="color: var(--danger)"><i class="fas fa-trash-alt"></i> ÿ≠ÿ∞ŸÅ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            tick();
        }

        // --- Ticking & Logic ---

        function tick() {
            const now = new Date().getTime();
            let needsRerender = false;

            events.forEach(ev => {
                const el = document.getElementById(`timer-${ev.id}`);
                if(!el) return;
                
                let target = new Date(ev.date).getTime();
                let diff = target - now;

                // 1. Recurrence Logic
                if (diff <= 0 && ev.recurrence && ev.recurrence !== 'none' && !ev.isRecycled) {
                    let d = new Date(ev.date);
                    if(ev.recurrence === 'annual') d.setFullYear(d.getFullYear() + 1);
                    if(ev.recurrence === 'monthly') d.setMonth(d.getMonth() + 1);
                    
                    ev.date = d.toISOString().slice(0,16);
                    ev.isRecycled = true; // Prevent loop
                    ev.notified = false;
                    save();
                    needsRerender = true;
                    showToast(`ÿ™ŸÖ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ≠ÿØÿ´: ${ev.title} üîÑ`);
                    return;
                }
                // Reset recycle flag
                if(diff > 0 && ev.isRecycled) ev.isRecycled = false;

                // 2. Notification Logic
                if (diff <= 0 && diff > -5000 && !ev.notified && (!ev.recurrence || ev.recurrence === 'none')) {
                    sendNotification(ev.title);
                    ev.notified = true;
                    save();
                }

                // 3. Timer UI
                if (diff < 0) diff = Math.abs(diff);
                const d = Math.floor(diff / (86400000));
                const h = Math.floor((diff % 86400000) / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);

                el.querySelector('.d').innerText = d;
                el.querySelector('.h').innerText = h < 10 ? '0'+h : h;
                el.querySelector('.m').innerText = m < 10 ? '0'+m : m;
                el.querySelector('.s').innerText = s < 10 ? '0'+s : s;

                // 4. Progress Bar
                const start = ev.created || (target - 86400000);
                let pct = ((now - start) / (target - start)) * 100;
                if(pct > 100) pct = 100; if(pct < 0) pct = 0;
                
                const fill = document.getElementById(`prog-fill-${ev.id}`);
                if(fill) fill.style.width = `${pct}%`;
            });

            if(needsRerender) renderEvents();
        }

        // --- Helpers ---

        function editEvent(id) {
            const ev = events.find(e => e.id === id);
            editingId = id;
            
            document.getElementById('modalTitle').innerText = 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≠ÿØÿ´';
            document.getElementById('saveBtn').innerText = 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™';
            document.getElementById('inpTitle').value = ev.title;
            document.getElementById('inpDate').value = ev.date;
            document.getElementById('inpRecur').value = ev.recurrence || 'none';
            document.getElementById('inpNotes').value = ev.notes || '';
            document.getElementById('inpBg').value = ev.bg || '';
            
            // Cat
            document.querySelectorAll('.cat-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.cat-option[data-val="${ev.cat}"]`).classList.add('selected');
            
            // Image toggle state
            if(ev.bg && !ev.bg.includes('source.unsplash.com')) {
                document.getElementById('autoImgToggle').classList.remove('toggle-active');
                document.getElementById('imgInputGroup').style.display = 'block';
            } else {
                document.getElementById('autoImgToggle').classList.add('toggle-active');
                document.getElementById('imgInputGroup').style.display = 'none';
            }

            document.getElementById('addModal').style.display = 'flex';
        }

        function openModal() {
            editingId = null;
            document.getElementById('modalTitle').innerText = 'ÿ≠ÿØÿ´ ÿ¨ÿØŸäÿØ';
            document.getElementById('saveBtn').innerText = 'ÿ≠ŸÅÿ∏';
            
            // Reset
            document.getElementById('inpTitle').value = '';
            // Default date: Now
            const nowIso = new Date(Date.now() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,16);
            document.getElementById('inpDate').value = nowIso;
            document.getElementById('inpRecur').value = 'none';
            document.getElementById('inpNotes').value = '';
            document.getElementById('inpBg').value = '';
            
            document.getElementById('addModal').style.display = 'flex';
            
            // Cat Logic
            document.querySelectorAll('.cat-option').forEach(opt => {
                opt.onclick = () => {
                    document.querySelectorAll('.cat-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                }
            });
        }
        function closeModal() { document.getElementById('addModal').style.display = 'none'; }
        
        function toggleImgInput() {
            const isActive = document.getElementById('autoImgToggle').classList.contains('toggle-active');
            document.getElementById('imgInputGroup').style.display = isActive ? 'none' : 'block';
        }

        function toggleTheme() {
            const b = document.body;
            const newTheme = b.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            b.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        if(localStorage.getItem('theme') === 'light') document.body.setAttribute('data-theme', 'light');
        
        function filterEvents(c) {
            currentFilter = c;
            document.querySelectorAll('.stat-chip').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            renderEvents();
        }

        function getCatLabel(c) { return {'personal':'ÿ¥ÿÆÿµŸä','work':'ÿπŸÖŸÑ','holiday':'ÿπÿ∑ŸÑÿ©'}[c] || 'ÿπÿßŸÖ'; }

        function showPresets() {
            document.getElementById('inpTitle').value = 'ÿ±ŸÖÿ∂ÿßŸÜ 2025';
            document.getElementById('inpDate').value = '2025-02-28T18:00';
            document.getElementById('inpRecur').value = 'annual';
            openModal();
            showToast('ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸÖŸàÿ∞ÿ¨ ÿ¨ÿßŸáÿ≤');
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(p => {
                notifPermission = p;
                if(p === 'granted') showToast('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ üîî');
            });
        }

        function sendNotification(title) {
            if(notifPermission === 'granted') {
                new Notification('ÿ≠ÿßŸÜ ÿßŸÑŸÖŸàÿπÿØ! üöÄ', { body: `ÿßŸÑÿ≠ÿØÿ´: ${title}` });
            }
        }

        // Export/Import
        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(events));
            a.download = "Events_Backup.json"; a.click();
        }
        function importData() {
            const i = document.createElement('input'); i.type='file';
            i.onchange=e=>{
                const r=new FileReader();
                r.onload=ev=>{ try{events=JSON.parse(ev.target.result);save();renderEvents();showToast('ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©');}catch{showToast('ŸÖŸÑŸÅ ÿÆÿßÿ∑ÿ¶',true);} };
                r.readAsText(e.target.files[0]);
            }; i.click();
        }

        // Share & QR
        function generateShareLink(id) {
            const ev = events.find(e => e.id === id);
            // Minimal data for short URL
            const str = JSON.stringify({t:ev.title, d:ev.date, c:ev.cat});
            const url = window.location.href.split('?')[0] + '?share=' + btoa(unescape(encodeURIComponent(str)));
            
            document.getElementById('shareInput').value = url;
            document.getElementById('qrContainer').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}">`;
            document.getElementById('shareModal').style.display = 'flex';
        }

        function copyShareLink() {
            const i = document.getElementById('shareInput'); i.select(); i.setSelectionRange(0,99999);
            document.execCommand('copy'); showToast('ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ');
        }

        function checkUrlForSharedEvent() {
            const p = new URLSearchParams(window.location.search);
            if(p.get('share')) {
                try {
                    const d = JSON.parse(decodeURIComponent(escape(atob(p.get('share')))));
                    if(confirm(`ŸàÿµŸÑŸÉ ÿ≠ÿØÿ´ ÿ¨ÿØŸäÿØ: ${d.t}\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ™Ÿáÿü`)) {
                        events.unshift({id:Date.now(), title:d.t, date:d.d, cat:d.c||'personal', created:Date.now(), pinned:false});
                        save(); renderEvents(); window.history.replaceState({},document.title, window.location.pathname);
                        showToast('ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© üéâ');
                    }
                } catch(e){}
            }
        }

        function speakTime(id) {
            const ev = events.find(e => e.id === id);
            const diff = new Date(ev.date) - new Date();
            const d = Math.floor(diff/86400000);
            const msg = new SpeechSynthesisUtterance(diff<0 ? `ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿ≠ÿØÿ´ ${ev.title}` : `ÿ®ÿßŸÇŸä ${d} ŸäŸàŸÖ ÿπŸÑŸâ ${ev.title}`);
            msg.lang='ar-SA'; window.speechSynthesis.speak(msg);
        }

        function showToast(msg, err=false) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.style.borderColor = err ? 'var(--danger)' : 'var(--success)';
            t.classList.add('show'); 
            clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(()=>t.classList.remove('show'),3000);
        }

        window.onclick = function(e) { if(e.target.classList.contains('modal-overlay')) e.target.style.display='none'; }
    </script>
</body>
</html>
